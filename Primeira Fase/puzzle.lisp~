;;;; puzzle.lisp
;;;; IA - Projeto #1
;;;; Autor: Tiago Farinha (201802235), Francisco Moura (201802033)

;;;; NOTA (IMPORTANTE!!!): PÔR A PASTA NA RAIZ DO C: PARA CONSEGUIR LÊR O FICHEIRO

(defun tabuleiro-vazio (&optional (dimensao 14))
  "Retorna um tabuleiro 14x14 (default) com as casas vazias"
	(make-list dimensao :initial-element (make-list dimensao :initial-element '0))
)

;; TABULEIRO VAZIO (REPRESENTAçãO VISUAL)
;;     A B C D E F G H I J K L M N
;  0| (0 0 0 0 0 0 0 0 0 0 0 0 0 0)
;  1| (0 0 0 0 0 0 0 0 0 0 0 0 0 0)
;  2| (0 0 0 0 0 0 0 0 0 0 0 0 0 0)
;  3| (0 0 0 0 0 0 0 0 0 0 0 0 0 0)
;  4| (0 0 0 0 0 0 0 0 0 0 0 0 0 0)
;  5| (0 0 0 0 0 0 0 0 0 0 0 0 0 0)
;  6| (0 0 0 0 0 0 0 0 0 0 0 0 0 0)
;  7| (0 0 0 0 0 0 0 0 0 0 0 0 0 0)
;  8| (0 0 0 0 0 0 0 0 0 0 0 0 0 0)
;  9| (0 0 0 0 0 0 0 0 0 0 0 0 0 0)
; 10| (0 0 0 0 0 0 0 0 0 0 0 0 0 0)
; 11| (0 0 0 0 0 0 0 0 0 0 0 0 0 0)
; 12| (0 0 0 0 0 0 0 0 0 0 0 0 0 0)
; 13| (0 0 0 0 0 0 0 0 0 0 0 0 0 0)


;----------------------------------------------------------------------------------------------------------------------------------------------------------------------

; | SELETORES |


(defun linha (index tray)
  "Função que recebe um Índice e o tabuleiro e retorna uma lista que representa essa linha do tabuleiro"
  (nth index tray)
)


(defun coluna (index tray)
  "Função que recebe um índice e o tabuleiro e retorna uma lista que representa essa coluna do tabuleiro."
  (mapcar #'(lambda (curr) (nth index curr)) tray)
)


(defun celula (line row tray)
  "Função que recebe dois índices (linha e coluna) e o tabuleiro e retorna o valor presente nessa calcula do tabuleiro."
  (if (equal (verificar-dentro-dos-limites line row) t)
      (nth row (nth line tray))
  )
)


(defun casa-vaziap (line row tray)
  "Função que recebe dois índices e o tabuleiro e verifica se a casa correspondente a essa posição se encontra vazia, ou seja, igual a 0."
  (if (equal (celula line row tray) 0)
      T NIL
  ) 
)

(defun verifica-casas-vazias (tray positions)
  "Função que recebe o tabuleiro e uma lista de pares de índices linha e coluna e devolve uma lista com T ou NIL caso se encontrem vazias."
  (mapcar #'(lambda (curr) 
              (if (equal (casa-vaziap (first curr) (second curr) tray) T) T NIL)
            ) positions)
)


(defun substituir-posicao (row lineList &optional (value 1))
  "Função que recebe um índice, uma lista e um valor (por default o valor é 1) e substitui pelo valor pretendido nessa posição"
  (let ((currPos 0))
    (mapcar #'(lambda (curr)          
                (if (and (= row currPos) (= curr 0)) (progn (setf currPos (1+ currPos)) value) 
                                    (progn (setf currPos (1+ currPos)) curr)
                )
              )
   lineList)
  )
)


(defun substituir (line row tray &optional (value 1))
  "Função que recebe 2 índices, o tabuleiro e um valor (por default = 1) e retorna o tabuleiro com a substituição pelo valor pretendido."
  (let ((currLine 0))
        (mapcar #'(lambda (curr)          
                (if (= line currLine) (progn (setf currLine (1+ currLine)) (substituir-posicao row (linha line tray) value)) 
                                      (progn (setf currLine (1+ currLine)) curr)
                )
              )
         tray)       
  )
)


;----------------------------------------------------------------------------------------------------------------------------------------------------------------------



; | OPERDADORES |



(defun peca-casas-ocupadas (line row piece)
"Função que recebe dois índices e um tipo de peça (peca-a, peca-b, peca-c-1 ou peca-c-2) e retorna uma lista com os pares de índices correspondentes às posições em que irá ser colocada a peça."
  (cond
     ((equal piece 'peca-a) (list (list line row)))
     ((equal piece 'peca-b) (list (list line row) (list line (1+ row)) (list (1+ line) row) (list (1+ line) (1+ row))))
     ((equal piece 'peca-c-1) (list (list line row) (list line (1+ row)) (list (1- line) (1+ row)) (list (1- line) (+ row 2))))
     ((equal piece 'peca-c-2) (list (list line row) (list (1+ line) row) (list (1+ line) (1+ row)) (list (+ line 2) (1+ row))))
  )
)


(defun peca-a (line row tray)
  "Funçãoo que recebe dois índices e o tabuleiro e coloca um quadrado de 1x1 no tabuleiro"
  (if (equal (verificar-peca-a line row tray) nil) 
      nil (substituir line row tray))
)


(defun peca-b (line row tray)
  "Função que recebe dois índices e o tabuleiro e coloca o quadrado 2x2 no tabuleiro tendo como ponto de referência o índice passado como argumento."
  (if (equal (verificar-peca-b line row tray) nil) 
       nil (progn (substituir (1+ line) (1+ row) (substituir (1+ line) row (substituir line (1+ row) (substituir line row tray)))))
  )  
)

(defun peca-c-1 (line row tray)
  "Função que recebe dois índices e o tabuleiro e coloca a peça 'esse' na posição de lado no tabuleiro tendo como ponto de referência o índice passado como argumento."
  (if (equal (verificar-peca-c-1 line row tray) nil)
        nil (progn (substituir (1- line) (+ row 2) (substituir (1- line) (1+ row) (substituir line (1+ row) (substituir line row tray)))))
  )
)  


(defun peca-c-2 (line row tray)
  "Função que recebe dois índices e o tabuleiro e coloca a peça 'esse' na posição para cima no tabuleiro tendo como ponto de referência o índice passado como argumento."
    (if (equal (verificar-peca-c-2 line row tray) nil) 
         nil (progn (substituir (+ line 2) (1+ row) (substituir (1+ line) (1+ row) (substituir (1+ line) row (substituir line row tray)))))   
    )   
)

;----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

; | VERIFICAÇÃO E COLOCAÇÃO DAS PEÇAS NO TABULEIRO |

(defun colocar-peca(peca line row tray)
"Função que chama uma das funções de colocação de uma peça"
  (cond
   ((equal peca 'peca-a) (peca-a line row tray))
   ((equal peca 'peca-b) (peca-b line row tray))
   ((equal peca 'peca-c-1) (peca-c-1 line row tray))
   ((equal peca 'peca-c-2) (peca-c-2 line row tray))
  )
)

(defun verificar-peca-encaixa-e-colocar (line row peca tray)
"Função que coloca a peça no tabuleiro, verificando se estas podem ser inseridas. Se todas as validações forem positivas, adicionar peça ao tabuleiro. NIL caso contrário."
    (if (equal (verificar-peca-encaixa line row peca tray) nil)
        nil
        (colocar-peca peca line row tray)
    )
)

(defun verificar-peca-encaixa (line row peca tray)
"Função que coloca a peça no tabuleiro, verificando se estas podem ser inseridas. Se todas as validações forem positivas, adicionar peça ao tabuleiro. NIL caso contrário."
  (let ((piece (peca-casas-ocupadas line row peca)))
    (if (not (member nil (mapcar #'(lambda (atual)
                (if 
                  (and  
                        (not (equal (celula (first atual) (1- (second atual)) tray) 1))  
                        (not (equal (celula (first atual) (1+ (second atual)) tray) 1))
                        (not (equal (celula (1- (first atual)) (second atual) tray) 1))
                        (not (equal (celula (1+ (first atual)) (second atual) tray) 1))
                        (verificar-dentro-dos-limites (first atual)(second atual))
                        (casa-vaziap (first atual) (second atual) tray))
                  t nil
                )
              )piece)))
        (if (or (member t (mapcar #'(lambda (atual)
                (if 
                  (and  
                        (or (equal (celula (1- (first atual)) (1- (second atual)) tray) 1)
                            (equal (celula (1+ (first atual)) (1- (second atual)) tray) 1)
                            (equal (celula (1- (first atual)) (1+ (second atual)) tray) 1)
                            (equal (celula (1+ (first atual)) (1+ (second atual)) tray) 1)        
                        )
                   )
                   t nil
                )
                ) piece))
      (member t (mapcar #'(lambda (atual)
                (if (and (equal (first atual) 0) (equal (second atual) 0))
                  t nil
                )
              ) piece)))
            t
)
     )
  )
)

(defun verificar-dentro-dos-limites (line row)
"Verifica se alguma das coordenada de uma calccula está fora do tabuleiro. T se todas estiverem dentro do tabuleir, NIL caso contrário."
  (if
   (and (>= line 0) 
        (<= line 13) 
        (>= row 0) 
        (<= row 13)) t nil
  )
)